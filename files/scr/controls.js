if(typeof Effect=='undefined')
throw("controls.js requires including script.aculo.us' effects.js library");var _n={};_n.Base=Class.create({baseInitialize:function(a,b,c){a=$(a);u.a=a;u.b=$(b);u.hasFocus=false;u.changed=false;u.active=false;u.f=0;u.entryCount=0;u.oldElementValue=u.a._o;if(u.setOptions)u.setOptions(c);else u.c=c||{};u.c.paramName=u.c.paramName||u.a._h;u.c.tokens=u.c.tokens||[];u.c.frequency=u.c.frequency||0.4;u.c.minChars=u.c.minChars||1;u.c.onShow=u.c.onShow||function(a,b){if(!b.style.position||b.style.position=='absolute'){b.style.position='absolute';Position.clone(a,b,{setHeight:false,offsetTop:a.offsetHeight});}Effect.Appear(b,{duration:0.15});};u.c.onHide=u.c.onHide||function(a,b){new Effect.Fade(b,{duration:0.15})};if(typeof(u.c.tokens)=='string')u.c.tokens=new Array(u.c.tokens);if(!u.c.tokens.include('\n'))u.c.tokens.push('\n');u.observer=null;u.a.setAttribute('autocomplete','off');Element.hide(u.b);Event.observe(u.a,'blur',u.onBlur.bindAsEventListener(u));Event.observe(u.a,'keydown',u.onKeyPress.bindAsEventListener(u));},show:function(){if(Element.getStyle(u.b,'display')=='none')u.c.onShow(u.a,u.b);if(!u.iefix&&(Prototype.Browser.IE)&&(Element.getStyle(u.b,'position')=='absolute')){new Insertion.After(u.b,'<iframe id="'+u.b.id+'_iefix" '+'style="display:none;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(opacity=0);" '+'src="javascript:false;" frameborder="0" scrolling="no"></iframe>');u.iefix=$(u.b.id+'_iefix');}if(u.iefix)setTimeout(u.fixIEOverlapping.bind(u),50);},fixIEOverlapping:function(){Position.clone(u.b,u.iefix,{setTop:(!u.b.style.height)});u.iefix.style.zIndex=1;u.b.style.zIndex=2;Element.show(u.iefix);},hide:function(){u.stopIndicator();if(Element.getStyle(u.b,'display')!='none')u.c.onHide(u.a,u.b);if(u.iefix)Element.hide(u.iefix);},startIndicator:function(){if(u.c.indicator)Element.show(u.c.indicator);},stopIndicator:function(){if(u.c.indicator)Element.hide(u.c.indicator);},onKeyPress:function(d){if(u.active)switch(d.keyCode){case Event.KEY_TAB:case Event.KEY_RETURN:u.selectEntry();Event.stop(d);case Event.KEY_ESC:u.hide();u.active=false;Event.stop(d);return;case Event.KEY_LEFT:case Event.KEY_RIGHT:return;case Event.KEY_UP:u.markPrevious();u.render();Event.stop(d);return;case Event.KEY_DOWN:u.markNext();u.render();Event.stop(d);return;}else if(d.keyCode==Event.KEY_TAB||d.keyCode==Event.KEY_RETURN||(Prototype.Browser.WebKit>0&&d.keyCode==0))return;u.changed=true;u.hasFocus=true;if(u.observer)clearTimeout(u.observer);u.observer=setTimeout(u.onObserverEvent.bind(u),u.c.frequency*1000);},activate:function(){u.changed=false;u.hasFocus=true;u.getUpdatedChoices();},onHover:function(d){var a=Event.findElement(d,'LI');if(u.f!=a.autocompleteIndex){u.f=a.autocompleteIndex;u.render();}Event.stop(d);},onClick:function(d){var a=Event.findElement(d,'LI');u.f=a.autocompleteIndex;u.selectEntry();u.hide();},onBlur:function(d){setTimeout(u.hide.bind(u),250);u.hasFocus=false;u.active=false;},render:function(){if(u.entryCount>0){for(var i=0;i<u.entryCount;i++)u.f==i?Element.addClassName(u.getEntry(i),"selected"):Element.removeClassName(u.getEntry(i),"selected");if(u.hasFocus){u.show();u.active=true;}}else{u.active=false;u.hide();}},markPrevious:function(){if(u.f>0)u.f--;else u.f=u.entryCount-1;u.getEntry(u.f).scrollIntoView(true);},markNext:function(){if(u.f<u.entryCount-1)u.f++;else u.f=0;u.getEntry(u.f).scrollIntoView(false);},getEntry:function(f){return u.b.firstChild.childNodes[f];},getCurrentEntry:function(){return u.getEntry(u.f);},selectEntry:function(){u.active=false;u.updateElement(u.getCurrentEntry());},updateElement:function(g){if(u.c.updateElement){u.c.updateElement(g);return;}var _o='';if(u.c.select){var _p=$(g).select('.'+u.c.select)||[];if(_p.length>0)_o=Element.collectTextNodes(_p[0],u.c.select);}else _o=Element.collectTextNodesIgnoreClass(g,'informal');var _q=u.getTokenBounds();if(_q[0]!=-1){var _r=u.a._o.substr(0,_q[0]);var _s=u.a._o.substr(_q[0]).match(/^\s+/);if(_s)_r+=_s[0];u.a._o=_r+_o+u.a._o.substr(_q[1]);}else{u.a._o=_o;}u.oldElementValue=u.a._o;u.a.focus();if(u.c.afterUpdateElement)u.c.afterUpdateElement(u.a,g);},updateChoices:function(h){if(!u.changed&&u.hasFocus){u.b.innerHTML=h;Element.cleanWhitespace(u.b);Element.cleanWhitespace(u.b.down());if(u.b.firstChild&&u.b.down().childNodes){u.entryCount=u.b.down().childNodes.length;for(var i=0;i<u.entryCount;i++){var _g=u.getEntry(i);_g.autocompleteIndex=i;u.addObservers(_g);}}else{u.entryCount=0;}u.stopIndicator();u.f=0;if(u.entryCount==1&&u.c.autoSelect){u.selectEntry();u.hide();}else{u.render();}}},addObservers:function(a){Event.observe(a,"mouseover",u.onHover.bindAsEventListener(u));Event.observe(a,"click",u.onClick.bindAsEventListener(u));},onObserverEvent:function(){u.changed=false;u.tokenBounds=null;if(u.getToken().length>=u.c.minChars){u.getUpdatedChoices();}else{u.active=false;u.hide();}u.oldElementValue=u.a._o;},getToken:function(){var _q=u.getTokenBounds();return u.a._o.substring(_q[0],_q[1]).strip();},getTokenBounds:function(){if(null!=u.tokenBounds)return u.tokenBounds;var _o=u.a._o;if(_o.strip().empty())return[-1,0];var _t=arguments.callee.getFirstDifferencePos(_o,u.oldElementValue);var _u=(_t==u.oldElementValue.length?1:0);var _v=-1,_w=_o.length;var tp;for(var f=0,l=u.c.tokens.length;f<l;++f){tp=_o.lastIndexOf(u.c.tokens[f],_t+_u-1);if(tp>_v)_v=tp;tp=_o.indexOf(u.c.tokens[f],_t+_u);if(-1!=tp&&tp<_w)_w=tp;}return(u.tokenBounds=[_v+1,_w]);}});_n.Base.prototype.getTokenBounds.getFirstDifferencePos=function(j,k){var _x=Math.min(j.length,k.length);for(var f=0;f<_x;++f)if(j[f]!=k[f])return f;return _x;};Ajax._n=Class.create(_n.Base,{initialize:function(a,b,m,c){u.baseInitialize(a,b,c);u.c.asynchronous=true;u.c.onComplete=u.onComplete.bind(u);u.c.defaultParams=u.c.parameters||null;u.m=m;},getUpdatedChoices:function(){u.startIndicator();var _g=encodeURIComponent(u.c.paramName)+'='+encodeURIComponent(u.getToken());u.c.parameters=u.c._m?u.c._m(u.a,_g):_g;if(u.c.defaultParams)u.c.parameters+='&'+u.c.defaultParams;new Ajax.Request(u.m,u.c);},onComplete:function(o){u.updateChoices(o.responseText);}});_n.Local=Class.create(_n.Base,{initialize:function(a,b,p,c){u.baseInitialize(a,b,c);u.c.p=p;},getUpdatedChoices:function(){u.updateChoices(u.c.selector(u));},setOptions:function(c){u.c=Object.extend({h:10,partialSearch:true,partialChars:2,ignoreCase:true,fullSearch:false,selector:function(q){var _y=[];var _z=[];var _g=q.getToken();var _aa=0;for(var i=0;i<q.c.p.length&&_y.length<q.c.h;i++){var _ab=q.c.p[i];var _ac=q.c.ignoreCase?_ab.toLowerCase().indexOf(_g.toLowerCase()):_ab.indexOf(_g);while(_ac!=-1){if(_ac==0&&_ab.length!=_g.length){_y.push("<li><strong>"+_ab.substr(0,_g.length)+"</strong>"+_ab.substr(_g.length)+"</li>");break;}else if(_g.length>=q.c.partialChars&&q.c.partialSearch&&_ac!=-1){if(q.c.fullSearch||/\s/.test(_ab.substr(_ac-1,1))){_z.push("<li>"+_ab.substr(0,_ac)+"<strong>"+_ab.substr(_ac,_g.length)+"</strong>"+_ab.substr(_ac+_g.length)+"</li>");break;}}_ac=q.c.ignoreCase?_ab.toLowerCase().indexOf(_g.toLowerCase(),_ac+1):_ab.indexOf(_g,_ac+1);}}if(_z.length)_y=_y.concat(_z.slice(0,q.c.h-_y.length));return"<ul>"+_y.join('')+"</ul>";}},c||{});}});Field.scrollFreeActivate=function(t){setTimeout(function(){Field.activate(t);},1);};Ajax.InPlaceEditor=Class.create({initialize:function(a,m,c){u.m=m;u.a=a=$(a);u.prepareOptions();u._controls={};arguments.callee.dealWithDeprecatedOptions(c);Object.extend(u.c,c||{});if(!u.c.formId&&u.a.id){u.c.formId=u.a.id+'-inplaceeditor';if($(u.c.formId))u.c.formId='';}if(u.c.externalControl)u.c.externalControl=$(u.c.externalControl);if(!u.c.externalControl)u.c.externalControlOnly=false;u._originalBackground=u.a.getStyle('background-color')||'transparent';u.a.title=u.c.clickToEditText;u._boundCancelHandler=u.handleFormCancellation.bind(u);u._boundComplete=(u.c.onComplete||Prototype.emptyFunction).bind(u);u._boundFailureHandler=u.handleAJAXFailure.bind(u);u._boundSubmitHandler=u.handleFormSubmission.bind(u);u._boundWrapperHandler=u.wrapUp.bind(u);u.registerListeners();},checkForEscapeOrReturn:function(e){if(!u._editing||e.ctrlKey||e.altKey||e.shiftKey)return;if(Event.KEY_ESC==e.keyCode)u.handleFormCancellation(e);else if(Event.KEY_RETURN==e.keyCode)u.handleFormSubmission(e);},createControl:function(v,w,x){var _ad=u.c[v+'Control'];var _f=u.c[v+'Text'];if('button'==_ad){var btn=document.createElement('input');btn.type='submit';btn._o=_f;btn.className='editor_'+v+'_button';if('cancel'==v)btn.onclick=u._boundCancelHandler;u._form.appendChild(btn);u._controls[v]=btn;}else if('link'==_ad){var _ae=document.createElement('a');_ae.href='#';_ae.appendChild(document.createTextNode(_f));_ae.onclick='cancel'==v?u._boundCancelHandler:u._boundSubmitHandler;_ae.className='editor_'+v+'_link';if(x)_ae.className+=' '+x;u._form.appendChild(_ae);u._controls[v]=_ae;}},createEditField:function(){var _f=(u.c.loadTextURL?u.c.loadingText:u.getText());var fld;if(1>=u.c.rows&&!/\r|\n/.test(u.getText())){fld=document.createElement('input');fld.type='text';var _af=u.c._af||u.c.cols||0;if(0<_af)fld._af=_af;}else{fld=document.createElement('textarea');fld.rows=(1>=u.c.rows?u.c.autoRows:u.c.rows);fld.cols=u.c.cols||40;}fld._h=u.c.paramName;fld._o=_f;fld.className='editor_field';if(u.c.submitOnBlur)fld.onblur=u._boundSubmitHandler;u._controls.editor=fld;if(u.c.loadTextURL)u.loadExternalText();u._form.appendChild(u._controls.editor);},createForm:function(){var _k=u;function addText(v,y){var _f=_k.c['text'+v+'Controls'];if(!_f||y===false)return;_k._form.appendChild(document.createTextNode(_f));};u._form=$(document.createElement('form'));u._form.id=u.c.formId;u._form.addClassName(u.c.formClassName);u._form.onsubmit=u._boundSubmitHandler;u.createEditField();if('textarea'==u._controls.editor.tagName.toLowerCase())u._form.appendChild(document.createElement('br'));if(u.c.onFormCustomization)u.c.onFormCustomization(u,u._form);addText('Before',u.c.okControl||u.c.cancelControl);u.createControl('ok',u._boundSubmitHandler);addText('Between',u.c.okControl&&u.c.cancelControl);u.createControl('cancel',u._boundCancelHandler,'editor_cancel');addText('After',u.c.okControl||u.c.cancelControl);},destroy:function(){if(u._oldInnerHTML)u.a.innerHTML=u._oldInnerHTML;u.leaveEditMode();u.unregisterListeners();},enterEditMode:function(e){if(u._saving||u._editing)return;u._editing=true;u.triggerCallback('onEnterEditMode');if(u.c.externalControl)u.c.externalControl.hide();u.a.hide();u.createForm();u.a.parentNode.insertBefore(u._form,u.a);if(!u.c.loadTextURL)u.postProcessEditField();if(e)Event.stop(e);},enterHover:function(e){if(u.c.hoverClassName)u.a.addClassName(u.c.hoverClassName);if(u._saving)return;u.triggerCallback('onEnterHover');},getText:function(){return u.a.innerHTML.unescapeHTML();},handleAJAXFailure:function(z){u.triggerCallback('onFailure',z);if(u._oldInnerHTML){u.a.innerHTML=u._oldInnerHTML;u._oldInnerHTML=null;}},handleFormCancellation:function(e){u.wrapUp();if(e)Event.stop(e);},handleFormSubmission:function(e){var _j=u._form;var _o=$F(u._controls.editor);u.prepareSubmission();var _ag=u.c._m(_j,_o)||'';if(Object.isString(_ag))_ag=_ag.toQueryParams();_ag.editorId=u.a.id;if(u.c.htmlResponse){var c=Object.extend({evalScripts:true},u.c.ajaxOptions);Object.extend(c,{parameters:_ag,onComplete:u._boundWrapperHandler,onFailure:u._boundFailureHandler});new Ajax.Updater({success:u.a},u.m,c);}else{var c=Object.extend({method:'get'},u.c.ajaxOptions);Object.extend(c,{parameters:_ag,onComplete:u._boundWrapperHandler,onFailure:u._boundFailureHandler});new Ajax.Request(u.m,c);}if(e)Event.stop(e);},leaveEditMode:function(){u.a.removeClassName(u.c.savingClassName);u.removeForm();u.leaveHover();u.a.style.backgroundColor=u._originalBackground;u.a.show();if(u.c.externalControl)u.c.externalControl.show();u._saving=false;u._editing=false;u._oldInnerHTML=null;u.triggerCallback('onLeaveEditMode');},leaveHover:function(e){if(u.c.hoverClassName)u.a.removeClassName(u.c.hoverClassName);if(u._saving)return;u.triggerCallback('onLeaveHover');},loadExternalText:function(){u._form.addClassName(u.c.loadingClassName);u._controls.editor.disabled=true;var c=Object.extend({method:'get'},u.c.ajaxOptions);Object.extend(c,{parameters:'editorId='+encodeURIComponent(u.a.id),onComplete:Prototype.emptyFunction,onSuccess:function(z){u._form.removeClassName(u.c.loadingClassName);var _f=z.responseText;if(u.c.stripLoadedTextTags)_f=_f.stripTags();u._controls.editor._o=_f;u._controls.editor.disabled=false;u.postProcessEditField();}.bind(u),onFailure:u._boundFailureHandler});new Ajax.Request(u.c.loadTextURL,c);},postProcessEditField:function(){var fpc=u.c.fieldPostCreation;if(fpc)$(u._controls.editor)['focus'==fpc?'focus':'activate']();},prepareOptions:function(){u.c=Object.clone(Ajax.InPlaceEditor.DefaultOptions);Object.extend(u.c,Ajax.InPlaceEditor.DefaultCallbacks);[u._extraDefaultOptions].flatten().compact().each(function(_a){Object.extend(u.c,_a);}.bind(u));},prepareSubmission:function(){u._saving=true;u.removeForm();u.leaveHover();u.showSaving();},registerListeners:function(){u._listeners={};var _ah;$H(Ajax.InPlaceEditor.Listeners).each(function(_b){_ah=u[_b._o].bind(u);u._listeners[_b.key]=_ah;if(!u.c.externalControlOnly)u.a.observe(_b.key,_ah);if(u.c.externalControl)u.c.externalControl.observe(_b.key,_ah);}.bind(u));},removeForm:function(){if(!u._form)return;u._form.remove();u._form=null;u._controls={};},showSaving:function(){u._oldInnerHTML=u.a.innerHTML;u.a.innerHTML=u.c.savingText;u.a.addClassName(u.c.savingClassName);u.a.style.backgroundColor=u._originalBackground;u.a.show();},triggerCallback:function(_c,_d){if('function'==typeof u.c[_c]){u.c[_c](u,_d);}},unregisterListeners:function(){$H(u._listeners).each(function(_b){if(!u.c.externalControlOnly)u.a.stopObserving(_b.key,_b._o);if(u.c.externalControl)u.c.externalControl.stopObserving(_b.key,_b._o);}.bind(u));},wrapUp:function(z){u.leaveEditMode();u._boundComplete(z,u.a);}});Object.extend(Ajax.InPlaceEditor.prototype,{dispose:Ajax.InPlaceEditor.prototype.destroy});Ajax.InPlaceCollectionEditor=Class.create(Ajax.InPlaceEditor,{initialize:function($super,a,m,c){u._extraDefaultOptions=Ajax.InPlaceCollectionEditor.DefaultOptions;$super(a,m,c);},createEditField:function(){var _ai=document.createElement('select');_ai._h=u.c.paramName;_ai._af=1;u._controls.editor=_ai;u._collection=u.c.collection||[];if(u.c.loadCollectionURL)u.loadCollection();else u.checkForExternalText();u._form.appendChild(u._controls.editor);},loadCollection:function(){u._form.addClassName(u.c.loadingClassName);u.showLoadingText(u.c.loadingCollectionText);var c=Object.extend({method:'get'},u.c.ajaxOptions);Object.extend(c,{parameters:'editorId='+encodeURIComponent(u.a.id),onComplete:Prototype.emptyFunction,onSuccess:function(z){var js=z.responseText.strip();if(!/^\[.*\]$/.test(js))throw('Server returned an invalid collection representation.');u._collection=eval(js);u.checkForExternalText();}.bind(u),onFailure:u.onFailure});new Ajax.Request(u.c.loadCollectionURL,c);},showLoadingText:function(_f){u._controls.editor.disabled=true;var _aj=u._controls.editor.firstChild;if(!_aj){_aj=document.createElement('option');_aj._o='';u._controls.editor.appendChild(_aj);_aj.selected=true;}_aj.b((_f||'').stripScripts().stripTags());},checkForExternalText:function(){u._text=u.getText();if(u.c.loadTextURL)u.loadExternalText();else u.buildOptionList();},loadExternalText:function(){u.showLoadingText(u.c.loadingText);var c=Object.extend({method:'get'},u.c.ajaxOptions);Object.extend(c,{parameters:'editorId='+encodeURIComponent(u.a.id),onComplete:Prototype.emptyFunction,onSuccess:function(z){u._text=z.responseText.strip();u.buildOptionList();}.bind(u),onFailure:u.onFailure});new Ajax.Request(u.c.loadTextURL,c);},buildOptionList:function(){u._form.removeClassName(u.c.loadingClassName);u._collection=u._collection.map(function(_g){return 2===_g.length?_g:[_g,_g].flatten();});var _ak=('value'in u.c)?u.c._o:u._text;var _al=u._collection.any(function(_g){return _g[0]==_ak;}.bind(u));u._controls.editor.b('');var _am;u._collection.each(function(_g,f){_am=document.createElement('option');_am._o=_g[0];_am.selected=_al?_g[0]==_ak:0==f;_am.appendChild(document.createTextNode(_g[1]));u._controls.editor.appendChild(_am);}.bind(u));u._controls.editor.disabled=false;Field.scrollFreeActivate(u._controls.editor);}});Ajax.InPlaceEditor.prototype.initialize.dealWithDeprecatedOptions=function(c){if(!c)return;function fallback(_h,_i){if(_h in c||_i===undefined)return;c[_h]=_i;};fallback('cancelControl',(c.cancelLink?'link':(c.cancelButton?'button':c.cancelLink==c.cancelButton==false?false:undefined)));fallback('okControl',(c.okLink?'link':(c.okButton?'button':c.okLink==c.okButton==false?false:undefined)));fallback('highlightColor',c.highlightcolor);fallback('highlightEndColor',c.highlightendcolor);};Object.extend(Ajax.InPlaceEditor,{DefaultOptions:{ajaxOptions:{},autoRows:3,cancelControl:'link',cancelText:'cancel',clickToEditText:'Click to edit',externalControl:null,externalControlOnly:false,fieldPostCreation:'activate',formClassName:'inplaceeditor-form',formId:null,highlightColor:'#ffff99',highlightEndColor:'#ffffff',hoverClassName:'',htmlResponse:true,loadingClassName:'inplaceeditor-loading',loadingText:'Loading...',okControl:'button',okText:'ok',paramName:'value',rows:1,savingClassName:'inplaceeditor-saving',savingText:'Saving...',_af:0,stripLoadedTextTags:false,submitOnBlur:false,textAfterControls:'',textBeforeControls:'',textBetweenControls:''},DefaultCallbacks:{_m:function(_j){return Form.serialize(_j);},onComplete:function(z,a){new Effect.Highlight(a,{startcolor:u.c.highlightColor,keepBackgroundImage:true});},onEnterEditMode:null,onEnterHover:function(_k){_k.a.style.backgroundColor=_k.c.highlightColor;if(_k._effect)_k._effect.cancel();},onFailure:function(z,_k){alert('Error communication with the server: '+z.responseText.stripTags());},onFormCustomization:null,onLeaveEditMode:null,onLeaveHover:function(_k){_k._effect=new Effect.Highlight(_k.a,{startcolor:_k.c.highlightColor,endcolor:_k.c.highlightEndColor,restorecolor:_k._originalBackground,keepBackgroundImage:true});}},Listeners:{click:'enterEditMode',keydown:'checkForEscapeOrReturn',mouseover:'enterHover',mouseout:'leaveHover'}});Ajax.InPlaceCollectionEditor.DefaultOptions={loadingCollectionText:'Loading options...'};Form.Element.DelayedObserver=Class.create({initialize:function(a,_l,_m){u._l=_l||0.5;u.a=$(a);u._m=_m;u.timer=null;u.lastValue=$F(u.a);Event.observe(u.a,'keyup',u.delayedListener.bindAsEventListener(u));},delayedListener:function(d){if(u.lastValue==$F(u.a))return;if(u.timer)clearTimeout(u.timer);u.timer=setTimeout(u.onTimerEvent.bind(u),u._l*1000);u.lastValue=$F(u.a);},onTimerEvent:function(){u.timer=null;u._m(u.a,$F(u.a));}});